<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RiderLink • MVP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#0b0c10; color:#e5e7eb; }
  #map { height:100%; width:100%; }

  /* Top right buttons */
  .stack { position:fixed; top:10px; right:10px; display:flex; flex-direction:column; gap:8px; z-index:900; transition:margin-right .2s ease; }
  .fab { background:#15171c; border:1px solid #1f2937; color:#e5e7eb; padding:8px 12px; border-radius:10px; cursor:pointer; display:flex; gap:8px; align-items:center; }
  .fab:hover { background:#1a1f2b; }
  .shiftRight { margin-right:420px; }
  @media (max-width: 640px) { .shiftRight { margin-right:92vw; } }

  /* Bottom dock */
  .dock { position:fixed; left:50%; bottom:18px; transform:translateX(-50%); display:flex; gap:12px; padding:10px; border-radius:16px; z-index:850; background:rgba(22,24,30,.6); border:1px solid rgba(60,68,80,.5); backdrop-filter:saturate(140%) blur(10px); }
  .dock .dockbtn { border:1px solid rgba(80,90,110,.7); background:rgba(35,40,50,.85); color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; }
  .dock .dockbtn.primary { background:#22c55e; border-color:#22c55e; color:#072c16; }

  /* Onboarding overlay centered */
  #onboard {
    position:fixed; inset:0; display:none; z-index:700; background:rgba(0,0,0,.55);
  }
  #onboardCenter {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center;
    background:#15171c; color:#e5e7eb; border:1px solid #1f2937;
    padding:14px 18px; border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35);
    max-width:min(90vw,520px);
  }
  #onboardTitle { font-weight:800; font-size:16px; }
  #onboardSub { font-size:12px; color:#cbd5e1; margin-top:6px; }

  /* Spotlight for Meet focus using CSS mask */
  #spot {
    position:fixed; inset:0; pointer-events:none; display:none; z-index:710;
    background: rgba(0,0,0,.6);
    --x: 50vw; --y: 50vh; --r: 240px;
    -webkit-mask-image: radial-gradient(circle var(--r) at var(--x) var(--y), transparent 0, transparent 99%, black 100%);
    mask-image: radial-gradient(circle var(--r) at var(--x) var(--y), transparent 0, transparent 99%, black 100%);
  }
  #spot.show { display:block; }

  /* Modals and cards */
  .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:1000; }
  .card { width:min(640px, 94vw); background:#15171c; border:1px solid #1f2937; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.45); }
  .card header { padding:14px 16px; border-bottom:1px solid #1f2937; font-weight:800; display:flex; align-items:center; justify-content:space-between; }
  .card main { padding:16px; }
  .row { display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; align-items:center; }
  .label { width:120px; color:#9ca3af; font-size:14px; }
  .inp, select, .palette { flex:1; min-width:160px; background:#0e1117; color:#e5e7eb; border:1px solid #232937; border-radius:8px; padding:10px 12px; }
  .hint { color:#9ca3af; font-size:12px; }
  .btn { border:1px solid #2a2f3b; background:#1f2430; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
  .btn.primary { background:#22c55e; border-color:#22c55e; color:#052914; font-weight:800; }
  .btn.ghost { background:transparent; }
  .footer { display:flex; justify-content:flex-end; gap:10px; padding:12px 16px; border-top:1px solid #1f2937; }

  .palette { display:flex; gap:8px; padding:8px; align-items:center; flex-wrap:wrap; }
  .swatch { width:26px; height:26px; border-radius:999px; border:2px solid #0b0c10; outline:2px solid transparent; cursor:pointer; }
  .swatch.sel { outline-color:#fff; }

  /* Toast */
  .toast { position:fixed; left:50%; transform:translateX(-50%); top:12px; background:#15171c; border:1px solid #1f2937; color:#e5e7eb; padding:10px 14px; border-radius:10px; z-index:999; display:none; }

  /* Chat drawer */
  #chat { position:fixed; right:0; top:0; bottom:0; width:min(420px, 92vw); transform:translateX(100%); transition:transform .2s ease; background:#0e0e0e; color:#fff; z-index:800; display:flex; flex-direction:column; border-left:1px solid #222; }
  #chat.open { transform:translateX(0%); }
  #chatHead { padding:10px 12px; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  #chatHead .left { display:flex; align-items:center; gap:8px; }
  #chatBody { flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:8px; }
  #chatActions { padding:8px 12px; border-top:1px solid #222; display:flex; flex-direction:column; gap:8px; }
  #quickChips { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-start; }
  #confirmWrap { display:flex; align-items:center; justify-content:center; }
  #confirmBar { display:none; gap:8px; align-items:center; }
  #confirmBar.show { display:flex; }
  #chatFoot { display:flex; gap:8px; padding:12px; border-top:1px solid #222; }
  .msg { padding:8px 10px; border-radius:10px; max-width:80%; }
  .msg.me { background:#1b5e20; margin-left:auto; }
  .msg.them { background:#263238; margin-right:auto; }

  /* Pick-on-map hint */
  .pickbar { position:fixed; top:8px; left:50%; transform:translateX(-50%); background:#15171c; border:1px solid #1f2937; color:#e5e7eb; padding:6px 10px; border-radius:999px; z-index:900; display:none; }

  /* Threads drawer */
  #threads { position:fixed; right:0; top:0; bottom:0; width:min(360px, 92vw); transform:translateX(100%); transition:transform .2s ease; background:#101214; color:#e5e7eb; z-index:750; border-left:1px solid #222; display:flex; flex-direction:column; }
  #threads.open { transform:translateX(0); }
  #threads header { padding:10px 12px; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; font-weight:800; }
  #threadList { flex:1; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:8px; }
  .thread { border:1px solid #1f2937; border-radius:10px; padding:8px 10px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .thread .meta { display:flex; flex-direction:column; }
  .thread small { color:#9ca3af; display:block; }
  .thread .del { border:1px solid #3b2323; background:#2a1616; color:#fca5a5; padding:6px 10px; border-radius:8px; cursor:pointer; }

  /* Helmet divIcon content */
  .helm { transform: translate(-50%, -50%); }
  .helmWrap { will-change: transform; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Onboarding overlay -->
<div id="onboard">
  <div id="onboardCenter">
    <div id="onboardTitle">Tap a rider to meet up</div>
    <div id="onboardSub">(click anywhere to start)</div>
  </div>
</div>

<!-- Spotlight for meet focus -->
<div id="spot"></div>

<!-- Top right buttons -->
<div class="stack" id="stack">
  <button id="riderCardBtn" class="fab">Rider Card</button>
  <button id="chatsBtn" class="fab">Chats</button>
</div>

<!-- Bottom dock -->
<div class="dock" id="dock">
  <button class="dockbtn" id="groupRideBtn">Create Group Ride</button>
  <button class="dockbtn primary" id="createMeetBtn">Create Meet Up</button>
  <button class="dockbtn" id="exploreBtn">Explore</button>
</div>

<!-- Pick hint -->
<div class="pickbar" id="pickbar">Tap anywhere on the map to set your location</div>

<!-- Rider Card modal -->
<div class="modal" id="riderModal" role="dialog" aria-modal="true" style="display:none">
  <div class="card">
    <header>
      <div>Rider Card</div>
      <button class="btn ghost" id="closeCard" title="Close">Close</button>
    </header>
    <main>
      <div class="row">
        <div class="label">Name</div>
        <input id="nameInp" class="inp" placeholder="Display name" />
      </div>
      <div class="row">
        <div class="label">Bike</div>
        <input id="bikeInp" class="inp" placeholder="e.g., MT-09, GSX-R, Tiger 900" />
      </div>
      <div class="row">
        <div class="label">Status</div>
        <select id="statusSel" class="inp">
          <option>Ready now</option>
          <option>Coffee</option>
          <option>Fuel stop</option>
          <option>Twisties</option>
          <option>Chill loop</option>
          <option>Lunch</option>
          <option>Rain check</option>
        </select>
      </div>

      <div class="row">
        <div class="label">Helmet color</div>
        <div class="palette" id="colorPalette"></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="label">Location</div>
        <div style="display:flex; flex-direction:column; gap:8px; flex:1">
          <label><input type="radio" name="locmode" value="live" checked> Live GPS</label>
          <div id="liveOptions" class="hint" style="margin-left:20px">
            Precision:
            <label style="margin-left:6px"><input type="radio" name="precision" value="approx" checked> Approx</label>
            <label style="margin-left:6px"><input type="radio" name="precision" value="exact"> Exact</label>
            <span class="hint" style="margin-left:8px">(Approx rounds to ~500 m grid)</span>
          </div>

          <label><input type="radio" name="locmode" value="pinned"> Manual location</label>
          <div id="pinOptions" style="display:none; gap:8px; flex-wrap:wrap; margin-left:20px">
            <button class="btn" id="pinPick">Pick on map</button>
            <span class="hint">Click the map. Your pick will auto save.</span>
          </div>

          <label><input type="radio" name="locmode" value="hidden"> Hidden</label>
          <div class="hint" style="margin-left:20px">You will not appear on the map.</div>
        </div>
      </div>
    </main>
    <div class="footer">
      <button class="btn primary" id="saveCard">Save</button>
    </div>
  </div>
</div>

<!-- Create Meet -->
<div class="modal" id="createMeetModal" style="display:none;">
  <div class="card" style="width:min(520px,92vw)">
    <header>
      <div>Create meet</div>
      <button class="btn ghost" id="closeCreate">Close</button>
    </header>
    <main>
      <div class="row">
        <div class="label">Title</div>
        <input id="meetTitle" class="inp" placeholder="Cars & Coffee, Night loop, etc." />
      </div>
      <div class="row">
        <div class="label">When</div>
        <select id="meetWhen" class="inp">
          <option value="in30">In 30 min</option>
          <option value="in60">In 1 hour</option>
          <option value="tonight">Tonight</option>
          <option value="tomorrow">Tomorrow</option>
        </select>
      </div>
      <div class="row">
        <div class="label">Location</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <button class="btn" id="meetPick">Pick on map</button>
          <span class="hint" id="meetLocHint">Choose a spot</span>
        </div>
      </div>
    </main>
    <div class="footer">
      <button class="btn primary" id="meetSave">Create</button>
    </div>
  </div>
</div>

<!-- Group Ride -->
<div class="modal" id="groupSheet" style="display:none;">
  <div class="card" style="width:min(520px,92vw)">
    <header>
      <div>Create group ride</div>
      <button class="btn ghost" id="closeGroup">Close</button>
    </header>
    <main>
      <div class="row">
        <div class="label">Title</div>
        <input id="groupTitle" class="inp" placeholder="Saturday loop, City night ride, etc." />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn primary" id="groupSave">Create</button>
      </div>
    </main>
  </div>
</div>

<!-- Explore -->
<div class="modal" id="exploreSheet" style="display:none;">
  <div class="card" style="width:min(560px,94vw)">
    <header>
      <div>Explore</div>
      <button class="btn ghost" id="closeExplore">Close</button>
    </header>
    <main>
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="hint">Browse current and upcoming meets</div>
        <label class="hint" style="display:flex; align-items:center; gap:6px">
          <input type="checkbox" id="exploreShowOnMap" /> Show on map
        </label>
      </div>
      <div id="exploreList" class="row" style="flex-direction:column; align-items:stretch"></div>
    </main>
  </div>
</div>

<!-- Threads drawer -->
<div id="threads">
  <header>
    <div>Chats</div>
    <button class="btn" id="threadsClose">Close</button>
  </header>
  <div id="threadList"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Chat -->
<div id="chat">
  <div id="chatHead">
    <div class="left">
      <strong id="chatTitle"></strong>
    </div>
    <div class="right">
      <button id="chatDelete" class="btn">Delete</button>
      <button id="chatClose" class="btn">Close</button>
    </div>
  </div>

  <div id="chatBody"></div>

  <div id="chatActions">
    <div id="quickChips"></div>
    <div id="confirmWrap">
      <div id="confirmBar">
        <span>Send meet request?</span>
        <button class="btn primary" id="confirmSend">Send</button>
        <button class="btn" id="confirmCancel">Cancel</button>
      </div>
    </div>
  </div>

  <div id="chatFoot">
    <input id="chatInput" class="inp" placeholder="Type a message" style="flex:1">
    <button class="btn primary" id="chatSend">Send</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Palette */
const PALETTE = ['#3b82f6','#ef4444','#84cc16','#f59e0b','#a855f7','#14b8a6','#ec4899','#64748b'];

/* Fake API */
const api = {
  listRidersAround: async ({ lat, lng }) => {
    const rnd = mulberry32(Math.floor(lat*1e4) ^ Math.floor(lng*1e4));
    const statuses = [{label:'Ready now'},{label:'Twisties'},{label:'Chill loop'},{label:'Coffee'},{label:'Fuel stop'},{label:'Lunch'}];
    const bikes = ['ZX6R','MT-09','R7','GSX-S750','Panigale V2','CBR650R','Tiger 900','T7','Z900'];
    return Array.from({length:10}).map((_,i)=>({
      id:'r'+i,
      name:'Rider '+(i+1),
      lat: lat + (rnd()-0.5)*0.06,
      lng: lng + (rnd()-0.5)*0.06,
      status: statuses[Math.floor(rnd()*statuses.length)],
      color: PALETTE[Math.floor(rnd()*PALETTE.length)],
      bike: bikes[Math.floor(rnd()*bikes.length)]
    }));
  },
  sendMessage: async (toId, body) => { console.log('[fake sendMessage]', { toId, body }); return { ok:true }; },
  upsertPresence: async ({ lat, lng, precision }) => { console.log('[fake upsertPresence]', { lat, lng, precision }); return { ok:true }; }
};

/* State */
const state = {
  map: null,
  profile: { name: "", bike: "", status: "Ready now", color: PALETTE[0] },
  locMode: "live",
  precision: "approx",
  pinned: null,
  liveWatchId: null,
  anchor: null,
  meMarker: null,
  meHalo: null,
  riderAnchors: new Map(),
  riderIcons: new Map(),
  currentMeetRider: null,
  meetDraft: { title:"", when:"in30", lat:null, lng:null },
  meetups: [],
  threads: [],
  coachArmed: false
};

/* Utils */
function toast(msg, ms=1800){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }
function showPickbar(show){ document.getElementById('pickbar').style.display = show ? 'block' : 'none'; }
function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function metersToDegLat(m){ return m/111320; }
function metersToDegLng(m, lat){ return m/(111320*Math.cos(lat * Math.PI/180) || 1); }
function roundApprox(lat,lng){ const dLat = metersToDegLat(500); const dLng = metersToDegLng(500, lat); const rLat = Math.round(lat/dLat)*dLat; const rLng = Math.round(lng/dLng)*dLng; return [ +rLat.toFixed(6), +rLng.toFixed(6) ]; }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function now(){ return Date.now(); }

/* Map */
function initMap(){
  state.map = L.map('map', { zoomControl:true });
  state.map.setView([20,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap' }).addTo(state.map);
}

/* Helmet icon v2 */
function helmetDivIcon(color){
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 32 32" aria-hidden="true">
    <g>
      <path d="M6 16a10 10 0 0 1 20 0v5a2 2 0 0 1-2 2h-8v-3h-4v3H8a2 2 0 0 1-2-2z"
            fill="${color}" stroke="#0a0a0a" stroke-width="2" />
      <path d="M17 11h9a1 1 0 0 1 .9 1.45l-2 4A1 1 0 0 1 23 17h-6z" fill="#fff"/>
      <path d="M8 16h18" stroke="#fff" stroke-width="1" opacity=".22"/>
      <circle cx="12" cy="12" r="1.2" fill="#0b0c10" opacity=".6"/>
      <path d="M12 8c2-1 5-1.4 8-.8" stroke="#0b0c10" stroke-width="1" opacity=".25"/>
    </g>
  </svg>`;
  return L.divIcon({
    className:'helm',
    html:`<div class="helmWrap">${svg}</div>`,
    iconSize:[24,24],
    iconAnchor:[12,12]
  });
}

/* Blue "Me" dot */
function drawMeAt(latlng){
  const me = L.circleMarker(latlng, { radius:7, color:'#60a5fa', weight:3, fillColor:'#60a5fa', fillOpacity:0.85, zIndexOffset: 500 }).addTo(state.map);
  me.bindTooltip('Me', { permanent:false, direction:'top', offset:[0,-12], opacity:1 });
  const halo = L.circleMarker(latlng, { radius:12, color:'#60a5fa', weight:2, fillColor:'#60a5fa', fillOpacity:0.12 }).addTo(state.map);
  if (state.meMarker) try { state.map.removeLayer(state.meMarker); } catch {}
  if (state.meHalo) try { state.map.removeLayer(state.meHalo); } catch {}
  state.meMarker = me;
  state.meHalo = halo;
}

/* Spotlight using CSS mask */
function showSpotAt(lat,lng, radiusPx=240){
  const spot = document.getElementById('spot');
  const pt = state.map.latLngToContainerPoint([lat,lng]);
  spot.style.setProperty('--x', pt.x + 'px');
  spot.style.setProperty('--y', pt.y + 'px');
  spot.style.setProperty('--r', radiusPx + 'px');
  spot.classList.add('show');

  function follow(){
    if (!spot.classList.contains('show')) return;
    const p2 = state.map.latLngToContainerPoint([lat,lng]);
    spot.style.setProperty('--x', p2.x + 'px');
    spot.style.setProperty('--y', p2.y + 'px');
  }
  function onMapMove(){ follow(); }
  function onResize(){ follow(); }
  function onEsc(e){ if (e.key === 'Escape') hideSpot(); }
  function onMapClick(){ hideSpot(); }

  state.map.on('move', onMapMove);
  window.addEventListener('resize', onResize);
  window.addEventListener('keydown', onEsc);
  state.map.once('click', onMapClick);

  spot._cleanup = () => {
    spot.classList.remove('show');
    state.map.off('move', onMapMove);
    window.removeEventListener('resize', onResize);
    window.removeEventListener('keydown', onEsc);
  };
}
function hideSpot(){
  const spot = document.getElementById('spot');
  if (spot._cleanup) spot._cleanup();
  spot.classList.remove('show');
}

/* Rider Card + palette */
function buildPalette(sel){
  const wrap = document.getElementById('colorPalette');
  wrap.innerHTML = '';
  PALETTE.forEach(col => {
    const d = document.createElement('div');
    d.className = 'swatch'+(col===sel?' sel':'');
    d.style.background = col;
    d.onclick = () => {
      document.querySelectorAll('.swatch').forEach(x=>x.classList.remove('sel'));
      d.classList.add('sel');
      state.profile.color = col;
    };
    wrap.appendChild(d);
  });
}
function openCard(prefillOnly=false){
  document.getElementById('nameInp').value = state.profile.name || "";
  document.getElementById('bikeInp').value = state.profile.bike || "";
  document.getElementById('statusSel').value = state.profile.status || "Ready now";
  buildPalette(state.profile.color || PALETTE[0]);
  document.querySelectorAll('input[name="locmode"]').forEach(r => r.checked = (r.value === state.locMode));
  document.querySelectorAll('input[name="precision"]').forEach(r => r.checked = (r.value === state.precision));
  toggleLocOptions();
  if (!prefillOnly) {
    document.getElementById('riderModal').style.display = 'flex';
    setTimeout(()=> state.map.invalidateSize(), 50);
  }
}
function closeCard(){
  document.getElementById('riderModal').style.display = 'none';
  armOnboardOverlay();
  setTimeout(()=> state.map.invalidateSize(), 50);
}
function saveCard(){
  state.profile.name = document.getElementById('nameInp').value.trim() || "Rider";
  state.profile.bike = document.getElementById('bikeInp').value.trim() || "Unknown";
  state.profile.status = document.getElementById('statusSel').value;
  state.locMode = document.querySelector('input[name="locmode"]:checked')?.value || "live";
  state.precision = document.querySelector('input[name="precision"]:checked')?.value || "approx";
  try {
    localStorage.setItem('profile', JSON.stringify(state.profile));
    localStorage.setItem('locMode', state.locMode);
    localStorage.setItem('precision', state.precision);
    if (state.pinned) localStorage.setItem('pinned', JSON.stringify(state.pinned));
  } catch {}
  applyLocationMode(true);
  closeCard();
}

/* Onboarding overlay control */
function armOnboardOverlay(){
  const o = document.getElementById('onboard');
  o.style.display = 'block';

  const dismiss = () => { o.style.display = 'none'; cleanup(); };
  const cleanup = () => {
    o.removeEventListener('click', dismiss);
    window.removeEventListener('keydown', anyKey);
    state.map.off('click', dismiss);
  };
  const anyKey = () => dismiss();

  o.addEventListener('click', dismiss);
  window.addEventListener('keydown', anyKey);
  state.map.once('click', dismiss);
}

/* Location modes */
function applyLocationMode(firstRun=false){
  if (state.liveWatchId != null) { navigator.geolocation.clearWatch(state.liveWatchId); state.liveWatchId = null; }
  if (state.meMarker) { try { state.map.removeLayer(state.meMarker); } catch {} state.meMarker = null; }
  if (state.meHalo) { try { state.map.removeLayer(state.meHalo); } catch {} state.meHalo = null; }

  if (state.locMode === 'hidden') {
    state.anchor = null;
    clearRiders();
    toast('Hidden. You will not appear on the map.');
    return;
  }

  if (state.locMode === 'pinned') {
    if (!state.pinned) {
      toast('Click Pick on map to set a manual location.');
      openCard(true);
      return;
    }
    state.anchor = [state.pinned.lat, state.pinned.lng];
    drawMeAt(state.anchor);
    state.map.setView(state.anchor, 13);
    seedAndDrawRiders();
    return;
  }

  if (!navigator.geolocation) {
    toast('GPS not available. Switch to Manual location.');
    state.locMode = 'pinned';
    openCard(true);
    return;
  }
  toast('Sharing live location' + (state.precision === 'approx' ? ' (approx)' : ''));
  state.liveWatchId = navigator.geolocation.watchPosition(
    async pos => {
      let lat = pos.coords.latitude, lng = pos.coords.longitude;
      let anchor = [lat, lng];
      if (state.precision === 'approx') anchor = roundApprox(lat, lng);
      state.anchor = anchor;

      drawMeAt([lat, lng]);
      if (firstRun) state.map.setView(anchor, 13);

      await api.upsertPresence({ lat: anchor[0], lng: anchor[1], precision: state.precision });
      seedAndDrawRiders();
    },
    () => { toast('GPS failed. Try Manual location.'); },
    { enableHighAccuracy: false, maximumAge: 5000, timeout: 8000 }
  );
}

/* Riders */
async function seedAndDrawRiders(){
  if (!state.anchor) { clearRiders(); return; }
  const [lat,lng] = state.anchor;
  const riders = await api.listRidersAround({ lat, lng });
  drawRiders(riders);
}
function drawRiders(riders){
  clearRiders();
  riders.forEach(r => {
    const anchorMarker = L.marker([r.lat, r.lng], { opacity:0 }).addTo(state.map);
    const html = `
      <div>
        <h4 style="margin:0 0 6px 0">${esc(r.name)}</h4>
        <div class="muted">${esc(r.bike)} • ${esc(r.status.label)}</div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="btn primary" data-act="meet">Meet</button>
        </div>
      </div>`;
    anchorMarker.bindPopup(html);

    const icon = helmetDivIcon(r.color || '#3b82f6');
    const marker = L.marker([r.lat, r.lng], { icon }).addTo(state.map);

    marker.on('click', () => {
      anchorMarker.openPopup();
      setTimeout(() => {
        const root = anchorMarker.getPopup()?.getElement();
        if (!root) return;
        root.querySelector('[data-act="meet"]').onclick = () => { meetFlow(r, marker); anchorMarker.closePopup(); };
      }, 0);
    });

    state.riderAnchors.set(r.id, anchorMarker);
    state.riderIcons.set(r.id, marker);
  });
}
function clearRiders(){
  for (const m of state.riderAnchors.values()) { try { state.map.removeLayer(m); } catch {} }
  for (const m of state.riderIcons.values()) { try { state.map.removeLayer(m); } catch {} }
  state.riderAnchors.clear(); state.riderIcons.clear();
}

/* Meet flow */
function meetFlow(r, marker){
  state.currentMeetRider = r;
  const targetZoom = Math.max(state.map.getZoom(), 15);
  state.map.flyTo([r.lat, r.lng], targetZoom, { duration: 0.6 });
  hideSpot();
  showSpotAt(r.lat, r.lng, 240);

  const el = marker._icon?.querySelector('.helmWrap');
  if (el) {
    el.style.transition = 'transform .15s ease';
    el.style.transformOrigin = 'center center';
    el.style.transform = 'scale(1.35)';
    setTimeout(()=>{ el.style.transform = 'scale(1)'; }, 900);
  }

  openChat(r);
  renderBottomChips([
    {label:'Coffee in 15', msg:'Coffee in 15 near you?'},
    {label:'Fuel then loop', msg:'Fuel stop then a short loop?'},
    {label:'Meet midpoint', msg:'Want to meet halfway? I can send a midpoint.'}
  ]);
  toggleConfirmBar(true);
}

/* Chat + threads */
function openChat(rider){
  persistThreadTouch(rider.id, rider.name);
  renderThreads();
  document.getElementById('chat').classList.add('open');
  document.getElementById('chatTitle').textContent = rider.name;
  document.getElementById('chatBody').innerHTML = '';
  addChatMsg(`Hey ${rider.name}, I am ${state.profile.name}.`, false);
  updateStackShift();
}
function closeChat(){
  document.getElementById('chat').classList.remove('open');
  toggleConfirmBar(false);
  hideSpot();
  updateStackShift();
}
function addChatMsg(text, me=true){
  const div = document.createElement('div');
  div.className = 'msg ' + (me ? 'me' : 'them');
  div.textContent = text;
  document.getElementById('chatBody').appendChild(div);
  document.getElementById('chatBody').scrollTop = 1e9;
  if (state.currentMeetRider && me) {
    persistThreadMessage(state.currentMeetRider.id, state.currentMeetRider.name, text);
    renderThreads();
  }
}

/* Delete chat helpers */
function deleteThreadById(id){
  const idx = state.threads.findIndex(t=>t.id===id);
  if (idx !== -1) { state.threads.splice(idx,1); saveThreads(); }
}
function deleteCurrentChat(){
  if (!state.currentMeetRider) return;
  const id = state.currentMeetRider.id;
  deleteThreadById(id);
  closeChat();
  renderThreads();
  toast('Chat deleted');
}

/* Threads store */
function loadThreads(){
  try { state.threads = JSON.parse(localStorage.getItem('threads')||'[]'); } catch { state.threads=[]; }
}
function saveThreads(){
  try { localStorage.setItem('threads', JSON.stringify(state.threads.slice(0,100))); } catch {}
}
function persistThreadTouch(id, name){
  const t = state.threads.find(x=>x.id===id);
  if (t){ t.ts = now(); } else { state.threads.unshift({ id, name, lastMsg:'', ts:now() }); }
  state.threads.sort((a,b)=>b.ts - a.ts);
  saveThreads();
}
function persistThreadMessage(id, name, msg){
  let t = state.threads.find(x=>x.id===id);
  if (!t){ t = { id, name, lastMsg:'', ts:now() }; state.threads.unshift(t); }
  t.lastMsg = msg; t.ts = now();
  state.threads.sort((a,b)=>b.ts - a.ts);
  saveThreads();
}
function renderThreads(){
  const list = document.getElementById('threadList');
  list.innerHTML = '';
  if (!state.threads.length){
    const p = document.createElement('div');
    p.className='hint';
    p.style.padding='10px';
    p.textContent = 'No chats yet';
    list.appendChild(p);
    return;
  }
  state.threads.forEach(t=>{
    const div = document.createElement('div');
    div.className='thread';
    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = `<strong>${esc(t.name)}</strong><small>${t.lastMsg ? esc(t.lastMsg) : 'No messages yet'}</small>`;
    const del = document.createElement('button');
    del.className='del';
    del.textContent='Delete';
    del.onclick = (e) => {
      e.stopPropagation();
      deleteThreadById(t.id);
      renderThreads();
      toast('Chat deleted');
    };
    div.onclick = () => {
      const rider = { id:t.id, name:t.name };
      state.currentMeetRider = rider;
      openChat(rider);
      document.getElementById('threads').classList.remove('open');
      updateStackShift();
    };
    div.appendChild(meta);
    div.appendChild(del);
    list.appendChild(div);
  });
}

/* Explore */
function openExplore(){
  renderExploreList();
  document.getElementById('exploreSheet').style.display = 'flex';
}
function closeExplore(){ document.getElementById('exploreSheet').style.display = 'none'; }
function renderExploreList(){
  const list = document.getElementById('exploreList');
  list.innerHTML = '';
  if (!state.meetups.length) {
    const p = document.createElement('div'); p.textContent = 'No meets yet. Create one below.'; p.className='hint';
    list.appendChild(p); return;
  }
  const showPins = document.getElementById('exploreShowOnMap')?.checked;
  state.meetups.forEach(m => {
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.padding='10px 12px'; row.style.border='1px solid #1f2937'; row.style.borderRadius='10px'; row.style.margin='6px 0';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${esc(m.title)}</strong><div class="hint">${esc(readableWhen(m.when))}</div>`;
    const right = document.createElement('div');
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='View';
    btn.onclick = () => { state.map.flyTo([m.lat,m.lng], 15, {duration:.6}); closeExplore(); };
    right.appendChild(btn);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);

    if (showPins && !m._pinShown) {
      m._pinShown = true;
      if (!m._pin) {
        m._pin = L.marker([m.lat,m.lng]).addTo(state.map)
          .bindTooltip('<span style="background:#111827;border:1px solid #374151;color:#e5e7eb;padding:2px 6px;border-radius:6px;font-size:11px;">Meet</span>', {permanent:true, direction:'top', offset:[0,-12]});
      }
    }
    if (!showPins && m._pinShown) { m._pinShown = false; if (m._pin) try{ state.map.removeLayer(m._pin); m._pin = null; }catch{} }
  });
}

/* Create Meet */
function openCreateMeet(){
  state.meetDraft = { title:"", when:"in30", lat:null, lng:null };
  document.getElementById('meetTitle').value = '';
  document.getElementById('meetWhen').value = 'in30';
  document.getElementById('meetLocHint').textContent = 'Choose a spot';
  document.getElementById('createMeetModal').style.display = 'flex';
}
function closeCreateMeet(){ document.getElementById('createMeetModal').style.display = 'none'; }
function pickMeetLocation(){
  closeCreateMeet();
  showPickbar(true);
  const once = e => {
    showPickbar(false);
    state.meetDraft.lat = e.latlng.lat;
    state.meetDraft.lng = e.latlng.lng;
    openCreateMeet();
    document.getElementById('meetLocHint').textContent = `Picked`;
  };
  state.map.once('click', once);
}
function saveMeet(){
  const title = document.getElementById('meetTitle').value.trim() || 'Group ride';
  const when = document.getElementById('meetWhen').value;
  const { lat, lng } = state.meetDraft;
  if (!(Number.isFinite(lat) && Number.isFinite(lng))) { toast('Pick a location'); return; }
  const m = { id: 'm'+Date.now(), title, when, lat, lng, createdAt: Date.now() };
  state.meetups.push(m);
  const pin = L.marker([lat,lng]).addTo(state.map)
    .bindTooltip('<span style="background:#111827;border:1px solid #374151;color:#e5e7eb;padding:2px 6px;border-radius:6px;font-size:11px;">Meet</span>', {permanent:true, direction:'top', offset:[0,-12]});
  m._pin = pin;
  closeCreateMeet();
  toast('Meet created');
  renderExploreList();
}

/* Manual loc pick */
function toggleLocOptions(){
  const mode = document.querySelector('input[name="locmode"]:checked')?.value;
  document.getElementById('liveOptions').style.display = mode === 'live' ? 'block' : 'none';
  document.getElementById('pinOptions').style.display  = mode === 'pinned' ? 'flex'  : 'none';
}
function startPickPin(){
  document.getElementById('riderModal').style.display = 'none';
  showPickbar(true);

  const once = e => {
    showPickbar(false);
    state.pinned = { lat:e.latlng.lat, lng:e.latlng.lng };
    try { localStorage.setItem('pinned', JSON.stringify(state.pinned)); } catch {}
    state.locMode = 'pinned';
    try { localStorage.setItem('locMode', state.locMode); } catch {}
    toast('Manual location saved');
    applyLocationMode(true);
  };
  state.map.once('click', once);
}

/* Threads drawer UI and top buttons shift */
function openThreads(){ document.getElementById('threads').classList.add('open'); updateStackShift(); }
function closeThreads(){ document.getElementById('threads').classList.remove('open'); updateStackShift(); }
function updateStackShift(){
  const stack = document.getElementById('stack');
  const chatOpen = document.getElementById('chat').classList.contains('open');
  const threadsOpen = document.getElementById('threads').classList.contains('open');
  if (chatOpen || threadsOpen) stack.classList.add('shiftRight');
  else stack.classList.remove('shiftRight');
}

/* Restore */
function restore(){
  try {
    const p = JSON.parse(localStorage.getItem('profile') || 'null'); if (p) state.profile = {...state.profile, ...p};
    const m = localStorage.getItem('locMode'); if (m) state.locMode = m;
    const pr = localStorage.getItem('precision'); if (pr) state.precision = pr;
    const pin = JSON.parse(localStorage.getItem('pinned') || 'null'); if (pin && Number.isFinite(pin.lat) && Number.isFinite(pin.lng)) state.pinned = pin;
    loadThreads();
  } catch {}
}

/* UI wiring */
document.getElementById('riderCardBtn').onclick = () => openCard();
document.getElementById('closeCard').onclick = () => closeCard();
document.getElementById('saveCard').onclick = () => saveCard();

document.getElementById('chatClose').onclick = closeChat;
document.getElementById('chatDelete').onclick = deleteCurrentChat;
document.getElementById('chatSend').onclick = () => {
  const inp = document.getElementById('chatInput'); const v = inp.value.trim();
  if (!v) return; addChatMsg(v, true); api.sendMessage('temp', v); inp.value='';
};
document.getElementById('confirmSend').onclick = () => {
  if (!state.currentMeetRider) return;
  addChatMsg(`Meet request sent to ${state.currentMeetRider.name}.`, true);
  toggleConfirmBar(false);
};
document.getElementById('confirmCancel').onclick = () => toggleConfirmBar(false);

document.querySelectorAll('input[name="locmode"]').forEach(r => r.onchange = toggleLocOptions);
document.getElementById('pinPick').onclick  = () => startPickPin();

/* Dock */
document.getElementById('createMeetBtn').onclick = openCreateMeet;
document.getElementById('closeCreate').onclick = closeCreateMeet;
document.getElementById('meetPick').onclick = () => pickMeetLocation();
document.getElementById('meetSave').onclick = () => saveMeet();

document.getElementById('groupRideBtn').onclick = () => { document.getElementById('groupSheet').style.display='flex'; };
document.getElementById('closeGroup').onclick = () => { document.getElementById('groupSheet').style.display='none'; };
document.getElementById('groupSave').onclick = () => { const t=document.getElementById('groupTitle').value.trim()||'Group ride'; toast('Group ride created: '+t); document.getElementById('groupSheet').style.display='none'; };

document.getElementById('exploreBtn').onclick = openExplore;
document.getElementById('closeExplore').onclick = closeExplore;
document.getElementById('exploreShowOnMap').onchange = renderExploreList;

/* Threads drawer */
document.getElementById('chatsBtn').onclick = openThreads;
document.getElementById('threadsClose').onclick = closeThreads;

/* Boot */
initMap();
restore();
openCard();
toggleLocOptions();

/* Minimal console tests */
(function tests(){
  const log = (ok, name, err) => ok ? console.log('✅', name) : console.error('❌', name, err||'');
  try { const c = state.map.getCenter(); if (!Number.isFinite(c.lat)) throw 'no center'; log(true,'Map has initial center'); } catch(e){ log(false,'Map has initial center', e); }
  try { document.getElementById('riderCardBtn'); log(true,'Rider Card button present'); } catch(e){ log(false,'Rider Card button present', e); }
})();

/* Helpers */
function readableWhen(w){
  if (w==='in30') return 'Starts in ~30 min';
  if (w==='in60') return 'Starts in ~1 hour';
  if (w==='tonight') return 'Tonight';
  if (w==='tomorrow') return 'Tomorrow';
  return 'Soon';
}
function renderBottomChips(chips){
  const wrap = document.getElementById('quickChips');
  wrap.innerHTML = '';
  chips.forEach(c => {
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = c.label;
    b.onclick = () => addChatMsg(c.msg, true);
    wrap.appendChild(b);
  });
}
function toggleConfirmBar(show){
  const bar = document.getElementById('confirmBar');
  if (show) bar.classList.add('show'); else bar.classList.remove('show');
}

/* Threads load/save used above */
function loadThreads(){ try { state.threads = JSON.parse(localStorage.getItem('threads')||'[]'); } catch { state.threads=[]; } }
function saveThreads(){ try { localStorage.setItem('threads', JSON.stringify(state.threads.slice(0,100))); } catch {} }

</script>
</body>
</html>
